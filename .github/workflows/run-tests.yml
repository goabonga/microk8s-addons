name: ğŸ§ª Run Tests ğŸš€

on:
  - push
  - pull_request

jobs:
  run-tests:
    name: ğŸ§ª Run All Tests
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Checkout Repository
        uses: actions/checkout@v4.2.1

      - name: âš™ï¸ Install Dependencies
        run: |
          sudo apt-get update
          sudo snap install microk8s --classic --channel=latest/edge

      - name: ğŸ¤– Set Up Python Environment
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: ğŸš€ Install Poetry for Root User
        run: |
          curl -sSL https://install.python-poetry.org | sudo python -

      - name: ğŸ›‹ Install Dependencies via Poetry
        run: |
          sudo /root/.local/bin/poetry env use /opt/hostedtoolcache/Python/3.12.7/x64/bin/python
          sudo /root/.local/bin/poetry install

      - name: ğŸ§© Install Addons for Tests
        run: |
          set -x
          sudo microk8s status --wait-ready --timeout 600
          sudo microk8s addons repo add testing .
          sudo microk8s status

      - name: ğŸ§ª Run Addons Tests
        run: |
          set -x
          sudo /root/.local/bin/poetry run pytest -s ./tests/test_addons.py

      - name: ğŸ”¥ Destroy MicroK8s Cluster
        run: |
          set -x
          sudo snap remove microk8s --purge
